name: Evaluate Trail Guide Agent

# This workflow runs automatically when changes are pushed to the agent's
# prompt or code files on a pull request targeting main.
# You can also trigger it manually from the Actions tab.
on:
  # Uncomment the lines below to enable automatic evaluation on pull requests
  pull_request:
    branches: [main]
    paths:
      - 'src/agents/trail_guide_agent/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write  # needed to post the PR comment

jobs:

  # ---------------------------------------------------------------------------
  # Job: comment
  # Reads evaluation_results.txt that was committed to the branch by the
  # student (produced locally by running evaluate_agent.py) and posts its
  # contents as a comment on the pull request.
  # ---------------------------------------------------------------------------
  comment:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      # Check out the branch so we can read the committed results file
      - name: Checkout repository
        uses: actions/checkout@v4

      # Post the contents of evaluation_results.txt as a PR comment
      - name: Post results as PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the results file committed to the branch
            const results = fs.readFileSync('evaluation_results.txt', 'utf8');

            const body = [
              '## Trail Guide Agent — Evaluation Results',
              '',
              'Evaluation results from the local run committed with this PR.',
              '',
              '<details>',
              '<summary>View full results</summary>',
              '',
              '```',
              results,
              '```',
              '',
              '</details>',
              '',
              '**Pass criteria (score ≥ 3 on a 1–5 scale):**',
              '- Intent Resolution',
              '- Relevance',
              '- Groundedness',
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              body:         body,
            });
