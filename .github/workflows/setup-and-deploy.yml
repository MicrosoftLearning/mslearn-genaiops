name: Full Azure AI Foundry Setup and Model Deployment with Validation

on:
  workflow_dispatch:

jobs:
  setup-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

    - name: Login to Azure
      run: |
        az login --service-principal \
          --username ${{ secrets.AZURE_CLIENT_ID }} \
          --password ${{ secrets.AZURE_CLIENT_SECRET }} \
          --tenant ${{ secrets.AZURE_TENANT_ID }}

    - name: Validate Azure Login
      run: |
        az account show || { echo "Azure login failed"; exit 1; }

    - name: Set subscription
      run: |
        az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Validate Subscription
      run: |
        az account show --query "id" -o tsv | grep ${{ secrets.AZURE_SUBSCRIPTION_ID }} || { echo "Subscription validation failed"; exit 1; }

    - name: Create Resource Group
      run: |
        az group create --name ${{ secrets.AZURE_RESOURCE_GROUP }} --location ${{ secrets.AZURE_REGION }}

    - name: Validate Resource Group
      run: |
        az group exists --name ${{ secrets.AZURE_RESOURCE_GROUP }} || { echo "Resource group creation failed"; exit 1; }

    - name: Create Azure AI Foundry Resource
      run: |
        az resource create \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name ${{ secrets.AZURE_PROJECT_NAME }} \
          --resource-type "Microsoft.AI/Foundry" \
          --location ${{ secrets.AZURE_REGION }} \
          --properties '{}' \
          --api-version 2024-05-01-preview

    - name: Validate AI Foundry Resource
      run: |
        az resource show \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name ${{ secrets.AZURE_PROJECT_NAME }} \
          --resource-type "Microsoft.AI/Foundry" \
          --api-version 2024-05-01-preview || { echo "AI Foundry resource creation failed"; exit 1; 


    - name: Deploy GPT-4o Model
      run: |
        az rest --method post \
          --url "https://management.azure.com/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.AZURE_RESOURCE_GROUP }}/providers/Microsoft.AI/Foundry/${{ secrets.AZURE_PROJECT_NAME }}/deployments?api-version=2024-05-01-preview" \
          --body '{
            "name": "gpt-4o-deployment",
            "properties": {
              "model": "${{ secrets.AZURE_MODEL_NAME }}",
              "scaleSettings": { "scaleType": "Standard" }
            }
          }'

    - name: Validate Deployment
      run: |
        STATUS=$(az rest --method get \
          --url "https://management.azure.com/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.AZURE_RESOURCE_GROUP }}/providers/Microsoft.AI/Foundry/${{ secrets.AZURE_PROJECT_NAME }}/deployments?api-version=2024-05-01-preview" \
          --query "value[0].properties.provisioningState" -o tsv)
        if [ "$STATUS" != "Succeeded" ]; then
          echo "Deployment failed with status: $STATUS"
          exit 1
        fi
        echo "Deployment succeeded!"
