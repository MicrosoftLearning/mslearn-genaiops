name: Deploy GPT-4o to Azure AI Foundry via REST API

on:
  workflow_dispatch:

jobs:
  deploy-ai-foundry:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

    - name: Login to Azure
      run: |
        az login --service-principal \
          --username ${{ secrets.AZURE_CLIENT_ID }} \
          --password ${{ secrets.AZURE_CLIENT_SECRET }} \
          --tenant ${{ secrets.AZURE_TENANT_ID }}

    - name: Get Access Token for AI Foundry
      id: get-token
      run: |
        TOKEN=$(az account get-access-token --resource https://ai.azure.com --query accessToken -o tsv)
        echo "token=$TOKEN" >> $GITHUB_OUTPUT

    - name: Create AI Foundry Project
      run: |
        curl -X POST "https://ai.azure.com/api/projects" \
          -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "'"${{ secrets.AZURE_PROJECT_NAME }}"'",
            "location": "'"${{ secrets.AZURE_REGION }}"'",
            "description": "AI Foundry project created via GitHub Actions"
          }'

    - name: Deploy GPT-4o Model
      run: |
        curl -X POST "https://ai.azure.com/api/projects/${{ secrets.AZURE_PROJECT_NAME }}/deployments" \
          -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "gpt-4o-deployment",
            "model": "'"${{ secrets.AZURE_MODEL_NAME }}"'",
            "scaleSettings": { "scaleType": "Standard" }
          }'

    - name: Validate Deployment
      run: |
        STATUS=$(curl -s -X GET "https://ai.azure.com/api/projects/${{ secrets.AZURE_PROJECT_NAME }}/deployments/gpt-4o-deployment" \
          -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
          | jq -r '.status')
        if [ "$STATUS" != "Succeeded" ]; then
          echo "Deployment failed with status: $STATUS"
          exit 1
        fi
        echo "Deployment succeeded!"

    - name: Get Endpoint
      run: |
        ENDPOINT=$(curl -s -X GET "https://ai.azure.com/api/projects/${{ secrets.AZURE_PROJECT_NAME }}" \
          -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
          | jq -r '.endpoint')
        echo "Azure AI Foundry Endpoint: $ENDPOINT"
